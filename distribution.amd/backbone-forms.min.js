define(["jquery","underscore","backbone1.0"],function(e,t,n){t.mixin({firstDefined:function(){for(var e=0;e<arguments.length;e++)if(arguments[e]!==undefined)return arguments[e]},pickDefaults:function(e){var n=Array.prototype.slice.call(arguments,1),r=this.defaults.apply(null,n);return t.pick(r,e)}}),Date.prototype.toISOString||(Date.prototype.toJSON||(Date.prototype.toJSON=function(e){function t(e){return e<10?"0"+e:e}return this.getUTCFullYear()+"-"+t(this.getUTCMonth()+1)+"-"+t(this.getUTCDate())+"T"+t(this.getUTCHours())+":"+t(this.getUTCMinutes())+":"+t(this.getUTCSeconds())+"Z"}),Date.prototype.toISOString=Date.prototype.toJSON);var r=n.View.extend({initialize:function(e){var n=this;e=e||{},this._chosen_editors=[],this._submitHandler=null,this.dependencyClass=e.dependencyClass||"";var r=this.schema=function(){if(e.schema)return t.result(e,"schema");var r=e.model;return r&&r.schema?t.isFunction(r.schema)?r.schema():r.schema:n.schema?t.isFunction(n.schema)?n.schema():n.schema:{}}();t.extend(this,t.pick(e,"model","data","idPrefix"));var i=this.constructor;this.template=e.template||i.template,this.Fieldset=e.Fieldset||i.Fieldset,this.Field=e.Field||i.Field,this.NestedField=e.NestedField||i.NestedField;var s=this.selectedFields=e.fields||t.keys(r),o=this.fields={};t.each(s,function(e){var t=r[e];o[e]=this.createField(e,t)},this);var u=e.fieldsets||[s],a=this.fieldsets=[];t.each(u,function(e){this.fieldsets.push(this.createFieldset(e))},this),this.setSubmitHandler(e.onSubmit)},createFieldset:function(e){var t={dependencyClass:this.dependencyClass,schema:e,fields:this.fields};return new this.Fieldset(t,this)},createField:function(e,t){var n={form:this,key:e,schema:t,idPrefix:this.idPrefix};this.model?n.model=this.model:this.data?n.value=this.data[e]:n.value=null;var r=new this.Field(n);return this.listenTo(r.editor,"all",this.handleEditorEvent),t&&t.type=="Chosen"&&(this._chosen_editors[this._chosen_editors.length]=r.editor),r},handleEditorEvent:function(e,n){var r=n.key+":"+e;this.trigger.call(this,r,this,n);switch(e){case"change":this.trigger("change",this);break;case"focus":this.hasFocus||this.trigger("focus",this);break;case"blur":if(this.hasFocus){var i=this;t.defer(function(){var e=t.find(i.fields,function(e){return e.editor.hasFocus});e||i.trigger("blur",i)})}}},render:function(){var n=this,r=this.fields,i=e(e.trim(this.template(t.result(this,"templateData"))));i.find("[data-editors]").add(i).each(function(i,s){var o=e(s),u=o.attr("data-editors");if(t.isUndefined(u))return;var a=u=="*"?n.selectedFields||t.keys(r):u.split(",");t.each(a,function(e){var t=r[e];o.append(t.editor.render().el)})}),i.find("[data-fields]").add(i).each(function(i,s){var o=e(s),u=o.attr("data-fields");if(t.isUndefined(u))return;var a=u=="*"?n.selectedFields||t.keys(r):u.split(",");t.each(a,function(e){var t=r[e];o.append(t.render().el)})}),i.find("[data-fieldsets]").add(i).each(function(r,i){var s=e(i),o=s.attr("data-fieldsets");if(t.isUndefined(o))return;t.each(n.fieldsets,function(e){s.append(e.render().el)})});var s=this._submitHandler;return typeof s=="function"&&i.submit(function(e){return s.call(n,e)}),this.setElement(i),this},validate:function(){var e=this,n=this.fields,r=this.model,i={};t.each(n,function(e){var t=e.validate();t&&(i[e.key]=t)});if(r&&r.validate){var s=r.validate(this.getValue());if(s){var o=t.isObject(s)&&!t.isArray(s);o||(i._others=i._others||[],i._others.push(s)),o&&t.each(s,function(e,t){if(n[t]&&!i[t])n[t].setError(e),i[t]=e;else{i._others=i._others||[];var r={};r[t]=e,i._others.push(r)}})}}return t.isEmpty(i)?null:i},commit:function(e){var n=this.validate();if(n)return n;var r,i=t.extend({error:function(e,t){r=t}},e);this.model.set(this.getValue(),i);if(r)return r},getValue:function(e){if(e)return this.fields[e].getValue();var n={};return t.each(this.fields,function(e){n[e.key]=e.getValue()}),n},setValue:function(e,t){var n={};typeof e=="string"?n[e]=t:n=e;var r;for(r in this.schema)n[r]!==undefined&&this.fields[r].setValue(n[r])},getEditor:function(e){var t=this.fields[e];if(!t)throw"Field not found: "+e;return t.editor},focus:function(){if(this.hasFocus)return;var e=this.fieldsets[0],t=e.getFieldAt(0);if(!t)return;t.editor.focus()},blur:function(){if(!this.hasFocus)return;var e=t.find(this.fields,function(e){return e.editor.hasFocus});e&&e.editor.blur()},trigger:function(e){return e==="focus"?this.hasFocus=!0:e==="blur"&&(this.hasFocus=!1),n.View.prototype.trigger.apply(this,arguments)},remove:function(){t.each(this.fieldsets,function(e){e.remove()}),t.each(this.fields,function(e){e.remove()}),n.View.prototype.remove.call(this)},initChosens:function(){for(var e=0;e<this._chosen_editors.length;e++)this._chosen_editors[e].initDisplay()},renderTo:function(t,n){n=n||"html",e(t)[n](this.render().el),this.initChosens()},setSubmitHandler:function(e){if(e==undefined)return;this._submitHandler=e}},{template:t.template("		<form data-fieldsets></form>	",null,this.templateSettings),templateSettings:{evaluate:/<%([\s\S]+?)%>/g,interpolate:/<%=([\s\S]+?)%>/g,escape:/<%-([\s\S]+?)%>/g},editors:{}}),i=r.extend({initialize:function(n){n=n||{};var r=this.mapSceSpecsToForm(n),i=t.defaults(r,n);this._submitView=null;if(n.submit){i.fieldsets||(i.fieldsets=[]),i.fieldsets.push([]);var s=t.defaults(n.submit,{schemaAttrs:n.submit,editorId:"",editorType:"submit"}),o=e(e.trim(n.fieldTemplate(s)));o.find("[data-editor]").add(o).each(function(r,i){var s=e(i),o=s.attr("data-editor");if(t.isUndefined(o))return;s.attr("replace")===undefined?s.append(n.submit.html):s.replaceWith(n.submit.html)}),this._submitView=o}this.current_errors={},this.constructor.__super__.initialize.call(this,i)},render:function(){this.constructor.__super__.render.call(this);var e=this.$el.find("[data-fieldsets]");e.length||(e=this.$el),e=e.children(":last-child");var t=e.find("[data-fields]");return t.length||(t=e),t.append(this._submitView),this},setErrors:function(e){e instanceof Array&&(e={}),t.each(e,function(e,t){if(!this.fields[t])throw new Error("Unknown field '"+t+"'");var n=e instanceof Array?e.join("<br/>"):e;this.fields[t].setSchemaAttr("errortext",n)},this),t.each(this.current_errors,function(t,n){e[n]||this.fields[n].setSchemaAttr("errortext",null)},this),this.current_errors=e},mapSceSpecsToForm:function(e){if(!e||!e.specs)return{};e.specs.categories&&e.specs.categories.content?e.specs=e.specs.categories.content:e.specs.content&&(e.specs=e.specs.content);if(e.specs instanceof Array&&e.specs.length<1)return{};var t={model:{},schema:{},fieldsets:[]};return this._parseCatContent(t,e,null,e.specs),t.model=new n.Model(t.model),t},_parseCatContent:function(e,t,n,r){if(!r)return;for(var i=0;i<r.length;i++)if(r[i].fields){if(n==null)throw new Error("Top level fields not supported");var s=[];n.content[n.content.length]={type:"fields",fields:s},this._parseXmlNest(r[i].fields,"field",this._parseField,[s,e,t])}else r[i].category&&this._parseXmlNest(r[i].category,null,this._parseFieldset,[e,t,n])},_parseXmlNest:function(e,t,n,r){if(!e)return;e=e instanceof Array?e:[e],r=r||[];for(var i=0;i<e.length;i++)if(!t||!e[i][t])n.apply(this,r.concat([e[i]]));else{var s=e[i][t];s=s instanceof Array?s:[s];for(var o=0;o<s.length;o++)n.apply(this,r.concat([s[o]]))}},_parseFieldset:function(e,t,n,r){var i={type:"fieldset",legend:r.name,help:r.description,content:[]};n?n.content[n.content.length]=i:e.fieldsets[e.fieldsets.length]=i,this._parseCatContent(e,t,i,r.content)},_parseField:function(e,t,n,r){var i=this._getFieldOptions(r,n);r.datatype=="range"?this._parseRangeField(e,t,i,r):this._parseNormalField(e,t,i,r);if(r.dependent_elements){var s={content:[]};e[e.length]=s.content,this._parseFieldset(t,n,s,{name:"",content:[{fields:{field:r.dependent_elements.field}}]})}},_parseRangeField:function(e,t,n,r){return this._parseNormalField(e,t,n,r)},_parseNormalField:function(e,t,n,r){var i=this._makeNewFieldByType(n,r);i.name=r.name,i.title=r.label,i.schemaAttrs=r,i.template=n.fieldTemplate,r.options&&(i.options=this._parseSelectOptions(r),n.addEmptySelectOption&&i.options.unshift({val:null,label:""})),t.schema[r.name]=i,t.model[r.name]=r.current_value,e[e.length]=r.name},_parseSelectOptions:function(e){if(!e.options.option)return e.options;var t=[];return this._parseXmlNest(e.options,"option",function(e){t[t.length]={val:e.option_value,label:e.option_label}}),t},_getFieldOptions:function(e,n){var r=t.pickDefaults(["addEmptySelectOption","useChosen","chosenOptions"],e,n,this.constructor.DEFAULTS);return r.fieldTemplate=t.firstDefined(e.template,n.fieldTemplate,this.constructor.Field.template),r},_makeNewFieldByType:function(e,t){switch(t.datatype){case"boolean":return{type:"Checkbox"};case"date":return{type:"Date"};case"int":return{type:"Text"};case"single_select":return{type:e.useChosen?"Chosen":"Select",chosenOptions:e.chosenOptions};case"multi_select":return{type:e.useChosen?"Chosen":"Checkboxes",chosenOptions:e.chosenOptions};case"range":return{type:"Range"};case"text":return{type:"Text"};case"textarea":return{type:"TextArea"};case"time":return{type:"Text"};case"uint":return{type:"Text"}}throw new Error("Unknown spec.datatype: '"+t.datatype+"'")}},{DEFAULTS:{addEmptySelectOption:!1,useChosen:!0,chosenOptions:{}}});r.validators=function(){var e={};return e.errMessages={required:"Required",regexp:"Invalid",email:"Invalid email address",url:"Invalid URL",match:t.template('Must match field "<%= field %>"',null,r.templateSettings)},e.required=function(e){return e=t.extend({type:"required",message:this.errMessages.required},e),function(r){e.value=r;var i={type:e.type,message:t.isFunction(e.message)?e.message(e):e.message};if(r===null||r===undefined||r===!1||r==="")return i}},e.regexp=function(e){if(!e.regexp)throw new Error('Missing required "regexp" option for "regexp" validator');return e=t.extend({type:"regexp",message:this.errMessages.regexp},e),function(r){e.value=r;var i={type:e.type,message:t.isFunction(e.message)?e.message(e):e.message};if(r===null||r===undefined||r==="")return;if(!e.regexp.test(r))return i}},e.email=function(n){return n=t.extend({type:"email",message:this.errMessages.email,regexp:/^[\w\-]{1,}([\w\-\+.]{1,1}[\w\-]{1,}){0,}[@][\w\-]{1,}([.]([\w\-]{1,})){1,3}$/},n),e.regexp(n)},e.url=function(n){return n=t.extend({type:"url",message:this.errMessages.url,regexp:/^(http|https):\/\/(([A-Z0-9][A-Z0-9_\-]*)(\.[A-Z0-9][A-Z0-9_\-]*)+)(:(\d+))?\/?/i},n),e.regexp(n)},e.match=function(e){if(!e.field)throw new Error('Missing required "field" options for "match" validator');return e=t.extend({type:"match",message:this.errMessages.match},e),function(r,i){e.value=r;var s={type:e.type,message:t.isFunction(e.message)?e.message(e):e.message};if(r===null||r===undefined||r==="")return;if(r!==i[e.field])return s}},e}(),r.Fieldset=n.View.extend({initialize:function(e){var n=this;e=e||{};var i=this.schema=this.createSchema(e.schema);this.fields=t.pick(e.fields,i.fields),this.dependencyClass=e.dependencyClass,this.cssClass=e.cssClass||"",this.content=[];var s=e.schema.content;s&&t.each(s,function(t){t.type=="fields"?n._registerFields(t.fields,e.fields):t.type=="fieldset"&&(n.content[n.content.length]=new r.Fieldset({dependencyClass:n.dependencyClass,schema:t,fields:e.fields}))}),this.template=e.template||this.constructor.template},_registerFields:function(e,n){t.each(e,function(e){e instanceof Array?this._registerDependants(e,n):this.content[this.content.length]=n[e]},this)},_registerDependants:function(e,n){var i=this.content[this.content.length-1].dependants;t.each(e,function(e){i[i.length]=new r.Fieldset({dependencyClass:this.dependencyClass,cssClass:this.dependencyClass,schema:e,fields:n})},this)},createSchema:function(e){return t.isArray(e)&&(e={fields:e}),e.legend=e.legend||null,e},getFieldAt:function(e){var t=this.schema.fields[e];return this.fields[t]},templateData:function(){return this.schema},render:function(){var n=this.schema,r=this.fields,i=this.content,s=e(e.trim(this.template(t.result(this,"templateData"))));return s.addClass(this.cssClass),s.find("[data-fields]").add(s).each(function(n,s){var o=e(s),u=o.attr("data-fields");if(t.isUndefined(u))return;t.each(r,function(e){o.append(e.render().el)});var a=!1,f=o;t.each(i,function(t){var n=t.render().$el;if(t.fields)n.insertAfter(f),f=n,a=!0;else{if(a){var r=e(o[0].cloneNode());r.insertAfter(f),f=o=r,a=!1}o.append(n)}})}),this.setElement(s),this},remove:function(){t.each(this.fields,function(e){e.remove()}),n.View.prototype.remove.call(this)}},{template:t.template("		<fieldset>			<% if (legend) { %>				<legend><%= legend %></legend>			<% } %>			<ol data-fields></ol> 		</fieldset>	",null,r.templateSettings)}),r.Field=n.View.extend({initialize:function(e){e=e||{},t.extend(this,t.pick(e,"form","key","model","value","idPrefix"));var n=this.schema=this.createSchema(e.schema);this.template=e.template||n.template||this.constructor.template,this.errorClassName=e.errorClassName||this.constructor.errorClassName,this.dependants=[],this.editor=this.createEditor()},createSchema:function(e){return t.isString(e)&&(e={type:e}),e=t.extend({type:"Text",title:this.createTitle()},e),e.schemaAttrs||(e.schemaAttrs={}),this.typeName=e.type,e.type=t.isString(e.type)?r.editors[e.type]:e.type,e},createEditor:function(){var e=t.extend(t.pick(this,"schema","form","key","model","value"),{id:this.createEditorId(),chosenOptions:this.schema.schemaAttrs.chosenOptions,placeholder:this.schema.schemaAttrs.placeholder}),n=this.schema.type;return new n(e)},createEditorId:function(){var e=this.idPrefix,n=this.key;return n=n.replace(/\./g,"_"),t.isString(e)||t.isNumber(e)?e+n:t.isNull(e)?n:this.model?this.model.cid+"_"+n:n},createTitle:function(){var e=this.key;return e=e.replace(/([A-Z])/g," $1"),e=e.replace(/^./,function(e){return e.toUpperCase()}),e},templateData:function(){var e=this.schema;return{help:e.help||"",title:e.title,fieldAttrs:e.fieldAttrs,editorAttrs:e.editorAttrs,schemaAttrs:e.schemaAttrs,key:this.key,editorId:this.editor.id,editorType:this.typeName}},render:function(){var n=this.schema,r=this.editor,i=e(e.trim(this.template(t.result(this,"templateData"))));n.fieldClass&&i.addClass(n.fieldClass),n.fieldAttrs&&i.attr(n.fieldAttrs),i.find("[data-editor]").add(i).each(function(n,i){var s=e(i),o=s.attr("data-editor");if(t.isUndefined(o))return;s.attr("replace")===undefined?s.append(r.render().el):s.replaceWith(r.render().el)}),t.each(this.dependants,function(e){i.append(e.render().el)}),this.$el.remove(),this.setElement(i);var s=this,o=function(){var e=this.getValue();t.each(s.dependants,function(t){e?t.$el.addClass("active"):t.$el.removeClass("active")})};return this.editor.on("change",o),o.call(this.editor),this},setSchemaAttr:function(e,t){this.schema.schemaAttrs[e]=t;var n=this.$el.next(),r=this.$el.parent();this.$el.remove(),n.length<1?r.append(this.render().$el):this.render().$el.insertBefore(n),this.typeName=="Chosen"&&this.editor.initDisplay(!0)},validate:function(){var e=this.editor.validate();return e?this.setError(e.message):this.clearError(),e},setError:function(e){if(this.editor.hasNestedForm)return;this.$el.addClass(this.errorClassName),this.$("[data-error]").html(e)},clearError:function(){this.$el.removeClass(this.errorClassName),this.$("[data-error]").empty()},commit:function(){return this.editor.commit()},getValue:function(){return this.editor.getValue()},setValue:function(e){this.editor.setValue(e)},focus:function(){this.editor.focus()},blur:function(){this.editor.blur()},remove:function(){this.editor.remove(),n.View.prototype.remove.call(this)}},{template:t.template('    <div>      <label for="<%= editorId %>"><%= title %></label>      <div>        <span data-editor></span>        <div data-error></div>        <div><%= help %></div>      </div>    </div>  ',null,r.templateSettings),errorClassName:"error"}),r.NestedField=r.Field.extend({template:t.template(e.trim("    <div>      <span data-editor></span>      <% if (help) { %>        <div><%= help %></div>      <% } %>      <div data-error></div>    </div>  "),null,r.templateSettings)}),r.Editor=r.editors.Base=n.View.extend({defaultValue:null,hasFocus:!1,initialize:function(e){var e=e||{};if(e.model){if(!e.key)throw"Missing option: 'key'";this.model=e.model,this.value=this.model.get(e.key)}else e.value&&(this.value=e.value);this.value===undefined&&(this.value=this.defaultValue),t.extend(this,t.pick(e,"key","form"));var n=this.schema=e.schema||{};this.validators=e.validators||n.validators,this.$el.attr("id",this.id),this.$el.attr("name",this.getName()),n.editorClass&&this.$el.addClass(n.editorClass),n.editorAttrs&&this.$el.attr(n.editorAttrs),this.has_rendered=!1},render:function(){return this.has_rendered||(this.setValue(this.value),this.has_rendered=!0),this},getName:function(){var e=this.key||"";return e.replace(/\./g,"_")},getValue:function(){return this.value},setValue:function(e){this.value=e},focus:function(){throw"Not implemented"},blur:function(){throw"Not implemented"},commit:function(e){var t=this.validate();if(t)return t;this.listenTo(this.model,"invalid",function(e,n){t=n}),this.model.set(this.key,this.getValue(),e);if(t)return t},validate:function(){var e=this.$el,n=null,r=this.getValue(),i=this.form?this.form.getValue():{},s=this.validators,o=this.getValidator;return s&&t.every(s,function(e){return n=o(e)(r,i),n?!1:!0}),n},trigger:function(e){return e==="focus"?this.hasFocus=!0:e==="blur"&&(this.hasFocus=!1),n.View.prototype.trigger.apply(this,arguments)},getValidator:function(e){var n=r.validators;if(t.isRegExp(e))return n.regexp({regexp:e});if(t.isString(e)){if(!n[e])throw new Error('Validator "'+e+'" not found');return n[e]()}if(t.isFunction(e))return e;if(t.isObject(e)&&e.type){var i=e;return n[i.type](i)}throw new Error("Invalid validator: "+e)}}),r.editors.Text=r.Editor.extend({tagName:"input",defaultValue:"",previousValue:"",events:{keyup:"determineChange",keypress:function(e){var t=this;setTimeout(function(){t.determineChange()},0)},select:function(e){this.trigger("select",this)},focus:function(e){this.trigger("focus",this)},blur:function(e){this.trigger("blur",this)}},initialize:function(e){r.editors.Base.prototype.initialize.call(this,e);var t=this.schema,n="text";t&&t.editorAttrs&&t.editorAttrs.type&&(n=t.editorAttrs.type),t&&t.dataType&&(n=t.dataType),this.$el.attr("type",n)},determineChange:function(e){var t=this.$el.val(),n=t!==this.previousValue;n&&(this.previousValue=t,this.trigger("change",this))},getValue:function(){return this.$el.val()},setValue:function(e){this.$el.val(e)},focus:function(){if(this.hasFocus)return;this.$el.focus()},blur:function(){if(!this.hasFocus)return;this.$el.blur()},select:function(){this.$el.select()}}),r.editors.TextArea=r.editors.Text.extend({tagName:"textarea"}),r.editors.Password=r.editors.Text.extend({initialize:function(e){r.editors.Text.prototype.initialize.call(this,e),this.$el.attr("type","password")}}),r.editors.Number=r.editors.Text.extend({defaultValue:0,events:t.extend({},r.editors.Text.prototype.events,{keypress:"onKeyPress"}),initialize:function(e){r.editors.Text.prototype.initialize.call(this,e),this.$el.attr("type","number"),this.$el.attr("step","any")},onKeyPress:function(e){var t=this,n=function(){setTimeout(function(){t.determineChange()},0)};if(e.charCode===0){n();return}var r=this.$el.val()+String.fromCharCode(e.charCode),i=/^[0-9]*\.?[0-9]*?$/.test(r);i?n():e.preventDefault()},getValue:function(){var e=this.$el.val();return e===""?null:parseFloat(e,10)},setValue:function(e){e=function(){return t.isNumber(e)?e:t.isString(e)&&e!==""?parseFloat(e,10):null}(),t.isNaN(e)&&(e=null),r.editors.Text.prototype.setValue.call(this,e)}}),r.editors.Hidden=r.editors.Base.extend({defaultValue:"",initialize:function(e){r.editors.Text.prototype.initialize.call(this,e),this.$el.attr("type","hidden")},focus:function(){},blur:function(){}}),r.editors.Checkbox=r.editors.Base.extend({defaultValue:!1,tagName:"input",events:{click:function(e){this.trigger("change",this)},focus:function(e){this.trigger("focus",this)},blur:function(e){this.trigger("blur",this)}},initialize:function(e){r.editors.Base.prototype.initialize.call(this,e),this.$el.attr("type","checkbox")},getValue:function(){return this.$el.prop("checked")},setValue:function(e){e&&this.$el.prop("checked",!0)},focus:function(){if(this.hasFocus)return;this.$el.focus()},blur:function(){if(!this.hasFocus)return;this.$el.blur()}}),r.editors.Select=r.editors.Base.extend({tagName:"select",events:{change:function(e){console.log("changed"),this.value=this.getValue(),this.trigger("change",this)},focus:function(e){this.trigger("focus",this)},blur:function(e){this.trigger("blur",this)}},initialize:function(e){r.editors.Base.prototype.initialize.call(this,e);if(!this.schema||!this.schema.options)throw"Missing required 'schema.options'"},render:function(){return this.setOptions(this.schema.options),r.editors.Base.prototype.render.call(this),this.has_rendered&&this.setValue(this.value),this.delegateEvents(),this},setOptions:function(e){var r=this;if(e instanceof n.Collection){var i=e;i.length>0?this.renderOptions(e):i.fetch({success:function(t){r.renderOptions(e)}})}else t.isFunction(e)?e(function(e){r.renderOptions(e)},r):this.renderOptions(e)},renderOptions:function(e){var t=this.$el,n;n=this._getOptionsHtml(e),t.html(n)},_getOptionsHtml:function(e){var r;if(t.isString(e))r=e;else if(t.isArray(e))r=this._arrayToHtml(e);else if(e instanceof n.Collection)r=this._collectionToHtml(e);else if(t.isFunction(e)){var i;e(function(e){i=e},this),r=this._getOptionsHtml(i)}return r},getValue:function(){return this.$el.val()},setValue:function(e){this.$el.val(e),this.value=e},focus:function(){if(this.hasFocus)return;this.$el.focus()},blur:function(){if(!this.hasFocus)return;this.$el.blur()},_collectionToHtml:function(e){var t=[];e.each(function(e){t.push({val:e.id,label:e.toString()})});var n=this._arrayToHtml(t);return n},_arrayToHtml:function(e){var n=[];return t.each(e,function(e){if(t.isObject(e))if(e.group)n.push('<optgroup label="'+e.group+'">'),n.push(this._getOptionsHtml(e.options)),n.push("</optgroup>");else{var r=e.val||e.val===0?e.val:"";n.push('<option value="'+r+'">'+e.label+"</option>")}else n.push("<option>"+e+"</option>")},this),n.join("")}}),r.editors.Chosen=r.editors.Select.extend({chosenOptions:null,initialize:function(e){r.editors.Select.prototype.initialize.call(this,e);if(!this.$el.chosen)throw new Error("Chosen plugin not detected!");this.chosenOptions=e.chosenOptions},focus:function(){if(this.hasFocus)return;this.$el.triggerHandler("focus")},blur:function(){if(!this.hasFocus)return;this.$el.triggerHandler("blur")},render:function(){r.editors.Select.prototype.render.call(this);var e=this.schema.schemaAttrs;return e&&e.datatype=="multi_select"&&(this.el.multiple="multiple"),this},initDisplay:function(e){e&&(this.$el.removeClass("chzn-done"),this.$el.show()),this.$el.closest(".dependent").css("display","block"),this.$el.chosen(this.chosenOptions),this.$el.closest(".dependent").css("display","")},remove:function(){this.$el.next().remove(),r.editors.Select.prototype.remove.call(this)}}),r.editors.Radio=r.editors.Select.extend({tagName:"ul",events:{"change input[type=radio]":function(){this.trigger("change",this)},"focus input[type=radio]":function(){if(this.hasFocus)return;this.trigger("focus",this)},"blur input[type=radio]":function(){if(!this.hasFocus)return;var e=this;setTimeout(function(){if(e.$("input[type=radio]:focus")[0])return;e.trigger("blur",e)},0)}},getValue:function(){return this.$("input[type=radio]:checked").val()},setValue:function(e){e instanceof Array||(e=[e]),this.$("input[type=radio]").val(e),this.value=e},focus:function(){if(this.hasFocus)return;var e=this.$("input[type=radio]:checked");if(e[0]){e.focus();return}this.$("input[type=radio]").first().focus()},blur:function(){if(!this.hasFocus)return;this.$("input[type=radio]:focus").blur()},_arrayToHtml:function(e){var n=[],r=this;return t.each(e,function(e,i){var s="<li>";if(t.isObject(e)){var o=e.val||e.val===0?e.val:"";s+='<input type="radio" name="'+r.getName()+'" value="'+o+'" id="'+r.id+"-"+i+'" />',s+='<label for="'+r.id+"-"+i+'">'+e.label+"</label>"}else s+='<input type="radio" name="'+r.getName()+'" value="'+e+'" id="'+r.id+"-"+i+'" />',s+='<label for="'+r.id+"-"+i+'">'+e+"</label>";s+="</li>",n.push(s)}),n.join("")}}),r.editors.Checkboxes=r.editors.Select.extend({tagName:"div",className:"checkboxes",events:{"click input[type=checkbox]":function(){this.trigger("change",this)},"focus input[type=checkbox]":function(){if(this.hasFocus)return;this.trigger("focus",this)},"blur input[type=checkbox]":function(){if(!this.hasFocus)return;var e=this;setTimeout(function(){if(e.$("input[type=checkbox]:focus")[0])return;e.trigger("blur",e)},0)}},getValue:function(){var t=[];return this.$("input[type=checkbox]:checked").each(function(){t.push(e(this).val())}),t},setValue:function(e){t.isArray(e)||(e=[e]),this.$("input[type=checkbox]").val(e),this.value=e},focus:function(){if(this.hasFocus)return;this.$("input[type=checkbox]").first().focus()},blur:function(){if(!this.hasFocus)return;this.$("input[type=checkbox]:focus").blur()},_arrayToHtml:function(e){var n=[],r=this;return t.each(e,function(e,i){var s="";if(t.isObject(e)){var o=e.val||e.val===0?e.val:"";s+='<input type="checkbox" name="'+r.getName()+'" value="'+o+'" id="'+r.id+"-"+i+'" />',s+='<label for="'+r.id+"-"+i+'">'+e.label+"</label>"}else s+='<input type="checkbox" name="'+r.getName()+'" value="'+e+'" id="'+r.id+"-"+i+'" />',s+='<label for="'+r.id+"-"+i+'">'+e+"</label>";s+="",n.push(s)}),n.join("")}}),r.editors.Range=r.editors.Base.extend({className:"range",events:{"keyup input":function(e){this.value=this.getValue()},"change input":function(e){this.value=this.getValue()},"focus input":function(e){this.trigger("focus",this)},"blur input":function(e){this.trigger("blur",this)},"select input":function(e){this.trigger("select",this)}},render:function(){var e='<input type="text"/><span> to </span><input type="text"/>';return this.$el.html(e),this.has_rendered&&this.setValue(this.value),r.editors.Base.prototype.render.call(this),this},getValue:function(){var e=this.$el.children("input");return t.map(e.toArray(),function(e){var t=parseFloat(e.value);return isNaN(t)?null:t})},setValue:function(e){if(!e)return;var t=this.$el.children("input");t[0].value=e[0],t[1].value=e[1],this.value=this.getValue()},focus:function(){if(this.hasFocus)return;this.$("input:first").focus()},blur:function(){if(!this.hasFocus)return;this.$("input:first").blur()},select:function(){this.$("input:first").select()}}),r.editors.Object=r.editors.Base.extend({hasNestedForm:!0,initialize:function(e){this.value={},r.editors.Base.prototype.initialize.call(this,e);if(!this.form)throw'Missing required option "form"';if(!this.schema.subSchema)throw new Error("Missing required 'schema.subSchema' option for Object editor")},render:function(){var e=this.form.constructor;return this.nestedForm=new e({schema:this.schema.subSchema,data:this.value,idPrefix:this.id+"_",Field:e.NestedField}),this._observeFormEvents(),this.$el.html(this.nestedForm.render().el),this.hasFocus&&this.trigger("blur",this),this},getValue:function(){return this.nestedForm?this.nestedForm.getValue():this.value},setValue:function(e){this.value=e,this.render()},focus:function(){if(this.hasFocus)return;this.nestedForm.focus()},blur:function(){if(!this.hasFocus)return;this.nestedForm.blur()},remove:function(){this.nestedForm.remove(),n.View.prototype.remove.call(this)},validate:function(){return this.nestedForm.validate()},_observeFormEvents:function(){if(!this.nestedForm)return;this.nestedForm.on("all",function(){var e=t.toArray(arguments);e[1]=this,this.trigger.apply(this,e)},this)}}),r.editors.NestedModel=r.editors.Object.extend({initialize:function(e){r.editors.Base.prototype.initialize.call(this,e);if(!this.form)throw'Missing required option "form"';if(!e.schema.model)throw'Missing required "schema.model" option for NestedModel editor'},render:function(){var e=this.form.constructor,t=this.value||{},n=this.key,r=this.schema.model,i=t.constructor===r?t:new r(t);return this.nestedForm=new e({model:i,idPrefix:this.id+"_",fieldTemplate:"nestedField"}),this._observeFormEvents(),this.$el.html(this.nestedForm.render().el),this.hasFocus&&this.trigger("blur",this),this},commit:function(){var e=this.nestedForm.commit();return e?(this.$el.addClass("error"),e):r.editors.Object.prototype.commit.call(this)}}),r.editors.Date=r.editors.Base.extend({events:{"change select":function(){this.updateHidden(),this.trigger("change",this)},"focus select":function(){if(this.hasFocus)return;this.trigger("focus",this)},"blur select":function(){if(!this.hasFocus)return;var e=this;setTimeout(function(){if(e.$("select:focus")[0])return;e.trigger("blur",e)},0)}},initialize:function(e){e=e||{},r.editors.Base.prototype.initialize.call(this,e);var n=r.editors.Date,i=new Date;this.options=t.extend({monthNames:n.monthNames,showMonthNames:n.showMonthNames},e),this.schema=t.extend({yearStart:i.getFullYear()-100,yearEnd:i.getFullYear()},e.schema||{}),this.value&&!t.isDate(this.value)&&(this.value=new Date(this.value));if(!this.value){var s=new Date;s.setSeconds(0),s.setMilliseconds(0),this.value=s}this.template=e.template||this.constructor.template},render:function(){var n=this.options,i=this.schema,s=t.map(t.range(1,32),function(e){return'<option value="'+e+'">'+e+"</option>"}),o=t.map(t.range(0,12),function(e){var t=n.showMonthNames?n.monthNames[e]:e+1;return'<option value="'+e+'">'+t+"</option>"}),u=i.yearStart<i.yearEnd?t.range(i.yearStart,i.yearEnd+1):t.range(i.yearStart,i.yearEnd-1,-1),a=t.map(u,function(e){return'<option value="'+e+'">'+e+"</option>"}),f=e(e.trim(this.template({dates:s.join(""),months:o.join(""),years:a.join("")})));return this.$date=f.find('[data-type="date"]'),this.$month=f.find('[data-type="month"]'),this.$year=f.find('[data-type="year"]'),this.$hidden=e('<input type="hidden" name="'+this.key+'" />'),f.append(this.$hidden),this.has_rendered&&this.setValue(this.value),this.setElement(f),this.$el.attr("id",this.id),this.$el.attr("name",this.getName()),this.hasFocus&&this.trigger("blur",this),r.editors.Base.prototype.render.call(this),this},getValue:function(){var e=this.$year.val(),t=this.$month.val(),n=this.$date.val();if(!e||!t||!n)return null;var r=new Date(e,t,n);return r.getTime()/1e3},setValue:function(e){return e instanceof Date||(e=new Date(e*1e3)),this.$date.val(e.getDate()),this.$month.val(e.getMonth()),this.$year.val(e.getFullYear()),this.updateHidden(),e},focus:function(){if(this.hasFocus)return;this.$("select").first().focus()},blur:function(){if(!this.hasFocus)return;this.$("select:focus").blur()},updateHidden:function(){var e=this.getValue();this.value=new Date(e*1e3),this.$hidden.val(e)}},{template:t.template('    <div class="date_picker">      <select data-type="date"><%= dates %></select>      <select data-type="month"><%= months %></select>      <select data-type="year"><%= years %></select>    </div>  ',null,r.templateSettings),showMonthNames:!0,monthNames:["January","February","March","April","May","June","July","August","September","October","November","December"]}),r.editors.DateTime=r.editors.Base.extend({events:{"change select":function(){this.updateHidden(),this.trigger("change",this)},"focus select":function(){if(this.hasFocus)return;this.trigger("focus",this)},"blur select":function(){if(!this.hasFocus)return;var e=this;setTimeout(function(){if(e.$("select:focus")[0])return;e.trigger("blur",e)},0)}},initialize:function(e){e=e||{},r.editors.Base.prototype.initialize.call(this,e),this.options=t.extend({DateEditor:r.editors.DateTime.DateEditor},e),this.schema=t.extend({minsInterval:1},e.schema||{}),this.dateEditor=new this.options.DateEditor(e),this.value&&!t.isDate(this.value)&&(this.value=new Date(this.value));if(!this.value){var n=new Date;n.setSeconds(0),n.setMilliseconds(0),this.value=n}this.template=e.template||this.constructor.template},render:function(){function n(e){return e<10?"0"+e:e}var i=this.schema,s=t.map(t.range(0,24),function(e){return'<option value="'+e+'">'+n(e)+"</option>"}),o=t.map(t.range(0,60,i.minsInterval),function(e){return'<option value="'+e+'">'+n(e)+"</option>"}),u=e(e.trim(this.template({hours:s.join(),mins:o.join()})));return u.find("[data-date]").append(this.dateEditor.render().el),this.$hour=u.find('select[data-type="hour"]'),this.$min=u.find('select[data-type="min"]'),this.$hidden=u.find('input[type="hidden"]'),this.has_rendered&&this.setValue(this.value),this.setElement(u),this.$el.attr("id",this.id),this.$el.attr("name",this.getName()),this.hasFocus&&this.trigger("blur",this),r.editors.Base.prototype.render.call(this),this},getValue:function(){var e=this.dateEditor.getValue(),t=this.$hour.val(),n=this.$min.val();return e?(e+=t*3600,e+=n*60,e):null},setValue:function(e){e=this.dateEditor.setValue(e),this.$hour.val(e.getHours()),this.$min.val(e.getMinutes()),this.updateHidden()},focus:function(){if(this.hasFocus)return;this.$("select").first().focus()},blur:function(){if(!this.hasFocus)return;this.$("select:focus").blur()},updateHidden:function(){var e=this.getValue();this.value=new Date(e*1e3),this.$hidden.val(e)},remove:function(){this.dateEditor.remove(),r.editors.Base.prototype.remove.call(this)}},{template:t.template('    <div class="bbf-datetime date_time_picker">      <div class="bbf-date-container" data-date></div>      <select data-type="hour"><%= hours %></select>      :      <select data-type="min"><%= mins %></select>    </div>  ',null,r.templateSettings),DateEditor:r.editors.Date}),i.VERSION=r.VERSION="0.12.0",n.SceForm=i,n.Form=r;for(var s in r)i.hasOwnProperty(s)||(i[s]=r[s]);return i})